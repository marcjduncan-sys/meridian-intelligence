name: Intraday Price Feed

on:
  schedule:
    # Every 15 minutes during ASX trading hours (Mon-Fri)
    # ASX opens 10:00 AEDT (23:00 UTC prev day) and closes 16:00 AEDT (05:00 UTC)
    # We run from 23:00 UTC to 06:00 UTC to cover pre-market through post-close
    # Cron doesn't support "every 15 min between hours" cleanly, so we use
    # multiple cron entries for trading-window coverage:
    - cron: '*/15 23 * * 0-4'  # 23:00-23:59 UTC Sun-Thu (Mon-Fri AEDT morning)
    - cron: '*/15 0-6 * * 1-5' # 00:00-06:59 UTC Mon-Fri (Mon-Fri AEDT trading day)
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  fetch-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch live prices
        run: node scripts/fetch-live-prices.js

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet data/live-prices.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No price changes detected."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Price changes detected."
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/live-prices.json
          git commit -m "Live prices â€” $(date -u +'%H:%M UTC %d %b %Y')"
          git push
